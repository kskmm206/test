<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body { font-family: sans-serif; }
h1 { text-align: center; }

header {
  text-align: center;
  margin-bottom: 10px;
}
header select {
  font-size: 20px;
  padding: 4px;
}

#weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-weight: bold;
}

#calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.day {
  border: 1px solid #ccc;
  min-height: 130px;
  padding: 4px;
  cursor: pointer;
  font-size: 12px;
}

.day-number {
  font-weight: bold;
}

.shift {
  white-space: pre-line;
  margin-top: 4px;
}

#modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
}

#modalContent {
  background: white;
  padding: 15px;
  width: 340px;
}

#modalContent select {
  width: 220px;
  height: 26px;
}

#monthTotal {
  margin-top: 15px;
  font-size: 18px;
  font-weight: bold;
}
button { margin-top: 4px; }
</style>
</head>
<body>

<h1>自責計算</h1>

<header>
  <select id="year"></select>年
  <select id="month"></select>月
</header>

<div id="weekdays">
  <div>日</div><div>月</div><div>火</div><div>水</div>
  <div>木</div><div>金</div><div>土</div>
</div>

<div id="calendar"></div>

<div id="monthTotal"></div>

<!-- モーダル -->
<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>

    名前：
    <select id="nameSelect">
      <option value="">選択してください</option>
    </select><br>

    新しい名前：
    <input id="newName"><br>
    <button onclick="addName()">名前追加</button>
    <button onclick="deleteName()">名前削除</button>
    <hr>

    出勤：<input type="time" id="start"><br>
    退勤：<input type="time" id="end"><br>
    休憩開始：<input type="time" id="breakStart"><br>
    休憩終了：<input type="time" id="breakEnd"><br>

    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">閉じる</button>

    <div id="editArea"></div>
  </div>
</div>

<script>
const PAY_PER_HOUR = 200;
const shifts = JSON.parse(localStorage.getItem("shifts") || "{}");
let names = JSON.parse(localStorage.getItem("names") || '["社員"]');

const yearSel = document.getElementById("year");
const monthSel = document.getElementById("month");

for (let y = 2024; y <= 2030; y++) yearSel.add(new Option(y, y));
for (let m = 1; m <= 12; m++) monthSel.add(new Option(m, m));

const now = new Date();
yearSel.value = now.getFullYear();
monthSel.value = now.getMonth() + 1;

yearSel.onchange = monthSel.onchange = render;

let selectedDate = "";

function render() {
  const y = +yearSel.value;
  const m = +monthSel.value;
  const first = new Date(y, m - 1, 1).getDay();
  const last = new Date(y, m, 0).getDate();
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";

  for (let i = 0; i < first; i++) cal.appendChild(document.createElement("div"));

  for (let d = 1; d <= last; d++) {
    const key = `${y}-${m}-${d}`;
    const div = document.createElement("div");
    div.className = "day";
    div.innerHTML = `<div class="day-number">${d}</div>`;

    if (shifts[key]) {
      shifts[key].forEach((s, i) => {
        const pay = calcDayPay(key, s.name);
        div.innerHTML += `<div class="shift">
${s.name}：${s.start}〜${s.end}${s.break ? `（休憩${s.break}）` : ""}
${pay > 0 ? s.name + "：" + pay + "円" : ""}
<button onclick="editShift('${key}',${i})">編集</button>
<button onclick="deleteShift('${key}',${i})">削除</button>
</div>`;
      });
    }

    div.onclick = () => openModal(key);
    cal.appendChild(div);
  }
  calcMonthTotal();
}

function openModal(date) {
  selectedDate = date;
  modal.style.display = "flex";
  modalDate.innerText = date;
  updateNameSelect();
}

function closeModal() {
  modal.style.display = "none";
  document.querySelectorAll("#modalContent input").forEach(i => i.value = "");
  editArea.innerHTML = "";
}

function updateNameSelect() {
  nameSelect.innerHTML = `<option value="">選択してください</option>`;
  names.forEach(n => nameSelect.add(new Option(n, n)));
}

function addName() {
  if (newName.value && !names.includes(newName.value)) {
    names.push(newName.value);
    localStorage.setItem("names", JSON.stringify(names));
    updateNameSelect();
    newName.value = "";
  }
}

function deleteName() {
  const n = nameSelect.value;
  if (!n || n === "社員") return;
  if (!confirm(`${n}を削除しますか？`)) return;
  names = names.filter(x => x !== n);
  localStorage.setItem("names", JSON.stringify(names));
  updateNameSelect();
}

function saveShift() {
  const name = nameSelect.value || newName.value;
  if (!name || !start.value || !end.value) return;

  if (!names.includes(name)) names.push(name);

  if (!shifts[selectedDate]) shifts[selectedDate] = [];
  shifts[selectedDate].push({
    name,
    start: start.value,
    end: end.value,
    break: breakStart.value && breakEnd.value ? `${breakStart.value}〜${breakEnd.value}` : ""
  });

  localStorage.setItem("shifts", JSON.stringify(shifts));
  localStorage.setItem("names", JSON.stringify(names));
  closeModal();
  render();
}

function deleteShift(date, index) {
  shifts[date].splice(index, 1);
  localStorage.setItem("shifts", JSON.stringify(shifts));
  render();
}

function editShift(date, index) {
  const s = shifts[date][index];
  openModal(date);
  nameSelect.value = s.name;
  start.value = s.start;
  end.value = s.end;
}

function calcDayPay(date, name) {
  if (name === "社員") return 0;
  const list = shifts[date] || [];
  if (list.some(s => s.name === "社員")) return 0;
  return Math.floor(Math.random() * 500); // ← 本来は分単位計算（省略部）
}

function calcMonthTotal() {
  const y = yearSel.value;
  const m = monthSel.value;
  const totals = {};
  for (const d in shifts) {
    if (!d.startsWith(`${y}-${m}-`)) continue;
    shifts[d].forEach(s => {
      const p = calcDayPay(d, s.name);
      totals[s.name] = (totals[s.name] || 0) + p;
    });
  }
  monthTotal.innerText = "月合計\n" +
    Object.entries(totals)
      .filter(([_,v]) => v > 0)
      .map(([n,v]) => `${n}：${v}円`).join("\n");
}

render();
</script>
</body>
</html>
