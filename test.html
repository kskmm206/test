<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body{font-family:sans-serif}
h1{text-align:center}
header{display:flex;justify-content:center;gap:10px;font-size:22px;margin-bottom:10px}
select{font-size:20px}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.week{font-weight:bold;text-align:center}
.day{border:1px solid #ccc;min-height:120px;padding:4px;font-size:12px}
.day-number{font-weight:bold}
.shift{margin-top:2px;white-space:pre-line}
.money{font-weight:bold}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;justify-content:center;align-items:center}
#modalContent{background:#fff;padding:10px;width:320px}
.row{margin-bottom:6px}
#total{margin-top:10px;font-size:18px;font-weight:bold}
button{margin-right:5px}
</style>
</head>
<body>
<h1>自責計算</h1>
<header>
<select id="year"></select>年
<select id="month"></select>月
</header>
<div id="calendar"></div>
<div id="total"></div>

<div id="modal">
<div id="modalContent">
<h3 id="modalDate"></h3>
<div class="row">名前：
<select id="nameSelect" style="width:180px"></select></div>
<div class="row">新しい名前：<input id="newName"></div>
<div class="row">出勤：<input type="time" id="start"></div>
<div class="row">退勤：<input type="time" id="end"></div>
<div class="row">休憩開始：<input type="time" id="breakStart"></div>
<div class="row">休憩終了：<input type="time" id="breakEnd"></div>
<div class="row">
<button onclick="save()">保存</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>
</div>

<script>
const shifts=JSON.parse(localStorage.getItem('shifts')||'{}');
let names=JSON.parse(localStorage.getItem('names')||'["社員"]');
let editIndex=null,selectedDate='';
const yearSel=document.getElementById('year');
const monthSel=document.getElementById('month');
for(let y=2024;y<=2030;y++)yearSel.add(new Option(y,y));
for(let m=1;m<=12;m++)monthSel.add(new Option(m,m));
const now=new Date();yearSel.value=now.getFullYear();monthSel.value=now.getMonth()+1;
yearSel.onchange=monthSel.onchange=render;

function render(){
const y=+yearSel.value,m=+monthSel.value;
const cal=document.getElementById('calendar');cal.innerHTML='';
['日','月','火','水','木','金','土'].forEach(w=>{const d=document.createElement('div');d.className='week';d.textContent=w;cal.appendChild(d)});
const first=new Date(y,m-1,1).getDay();
const last=new Date(y,m,0).getDate();
for(let i=0;i<first;i++)cal.appendChild(document.createElement('div'));
for(let d=1;d<=last;d++){
const key=`${y}-${m}-${d}`;
const div=document.createElement('div');div.className='day';
let html=`<div class="day-number">${d}</div>`;
(shifts[key]||[]).forEach((s,i)=>{
const money=calcDayMoney(key,s.name);
html+=`<div class="shift">${s.name}：${s.start}〜${s.end}${s.break?`（休憩${s.break}）`:''}\n${money>0?`<span class='money'>${money}円</span>`:''}\n<button onclick=edit('${key}',${i})>編集</button><button onclick=del('${key}',${i})>削除</button></div>`;
});
div.innerHTML=html;
div.onclick=()=>openModal(key);
cal.appendChild(div);
}
calcMonthTotal();
}

function openModal(date){selectedDate=date;editIndex=null;document.getElementById('modal').style.display='flex';document.getElementById('modalDate').innerText=date;updateNameSelect()}
function closeModal(){document.getElementById('modal').style.display='none';document.querySelectorAll('#modalContent input').forEach(i=>i.value='')}
function updateNameSelect(){const sel=nameSelect;sel.innerHTML='<option value="">選択してください</option>';names.forEach(n=>sel.add(new Option(n,n)))}
function save(){const name=newName.value||nameSelect.value;if(!name)return;if(!names.includes(name))names.push(name);
if(!shifts[selectedDate])shifts[selectedDate]=[];
const data={name,start:start.value,end:end.value,break:(breakStart.value&&breakEnd.value)?`${breakStart.value}〜${breakEnd.value}`:''};
if(editIndex!==null)shifts[selectedDate][editIndex]=data;else shifts[selectedDate].push(data);
localStorage.setItem('shifts',JSON.stringify(shifts));localStorage.setItem('names',JSON.stringify(names));closeModal();render();}
function edit(d,i){selectedDate=d;editIndex=i;const s=shifts[d][i];openModal(d);nameSelect.value=s.name;start.value=s.start;end.value=s.end;if(s.break){[breakStart.value,breakEnd.value]=s.break.split('〜')}}
function del(d,i){if(confirm('削除しますか')){shifts[d].splice(i,1);localStorage.setItem('shifts',JSON.stringify(shifts));render()}}
function calcDayMoney(date,name){
const list=(shifts[date]||[]).filter(s=>s.name!=='社員');
if(list.some(s=>s.name==='社員'))return 0;
let total=0;
list.forEach(s=>{
if(s.name!==name)return;
const toMin=t=>{const[a,b]=t.split(':').map(Number);return a*60+b};
let st=Math.max(toMin(s.start),615),ed=Math.min(toMin(s.end),1320);
if(st>=ed)return;
let work=[[st,ed]];
if(s.break){const[b1,b2]=s.break.split('〜').map(toMin);work=[[st,b1],[b2,ed]]}
work.forEach(w=>{
let minutes=0;
for(let t=w[0];t<w[1];t++){
const cnt=list.filter(x=>{
let xs=Math.max(toMin(x.start),615),xe=Math.min(toMin(x.end),1320);
if(x.break){const[bs,be]=x.break.split('〜').map(toMin);return t>=xs&&t<xe&&(t<bs||t>=be)}
return t>=xs&&t<xe}).length;
if(cnt===1)minutes+=1;else if(cnt===2)minutes+=0.5;
}
total+=Math.floor(minutes*200/60);
});
return total;
}
function calcMonthTotal(){const y=yearSel.value,m=monthSel.value;const sum={};for(const d in shifts){if(!d.startsWith(`${y}-${m}-`))continue;shifts[d].forEach(s=>{const v=calcDayMoney(d,s.name);sum[s.name]=(sum[s.name]||0)+v})}
document.getElementById('total').innerText='月合計\n'+Object.entries(sum).map(([n,v])=>`${n}：${v}円`).join('\n')}
render();
</script>
</body>
</html>