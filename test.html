<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>

<style>
body { font-family: sans-serif; }
h1 { text-align:center; }

#ym {
  text-align:center;
  font-size:20px;
  margin-bottom:10px;
}
#ym select { font-size:20px; }

#week {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  text-align:center;
  font-weight:bold;
}

#calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}

.day {
  border:1px solid #ccc;
  min-height:120px;
  padding:4px;
  font-size:12px;
  cursor:pointer;
}

.shift { white-space:pre-line; }

.bold { font-weight:bold; }

#total {
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}

#modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.4);
  display:none; justify-content:center; align-items:center;
}

#modalContent {
  background:white;
  padding:15px;
  width:320px;
}

button { margin:2px; }

.nameSelect {
  width:200px;
}
</style>
</head>

<body>

<h1>自責計算</h1>

<div id="ym">
  <select id="year"></select> 年
  <select id="month"></select> 月
</div>

<div id="week">
  <div>日</div><div>月</div><div>火</div><div>水</div>
  <div>木</div><div>金</div><div>土</div>
</div>

<div id="calendar"></div>

<div id="total"></div>

<!-- 入力モーダル -->
<div id="modal">
<div id="modalContent">
<h3 id="modalDate"></h3>

名前：
<select id="nameSelect" class="nameSelect">
  <option value="">選択してください</option>
</select>
<button onclick="deleteName()">名前削除</button><br><br>

新しい名前：<input id="newName"><br><br>

出勤 <input type="time" id="start"><br>
退勤 <input type="time" id="end"><br>
休憩開始 <input type="time" id="breakStart"><br>
休憩終了 <input type="time" id="breakEnd"><br><br>

<button onclick="saveShift()">保存</button>
<button onclick="closeModal()">閉じる</button>
</div>
</div>

<script>
const shifts = JSON.parse(localStorage.getItem("shifts")||"{}");
let names = JSON.parse(localStorage.getItem("names")||'["社員"]');
let editIndex = null;
let selectedDate = "";

const yearSel = year.value;
for(let y=2024;y<=2030;y++) year.add(new Option(y,y));
for(let m=1;m<=12;m++) month.add(new Option(m,m));

year.value=new Date().getFullYear();
month.value=new Date().getMonth()+1;

year.onchange=month.onchange=render;

function render(){
  calendar.innerHTML="";
  const y=+year.value, m=+month.value;
  const first=new Date(y,m-1,1).getDay();
  const last=new Date(y,m,0).getDate();

  for(let i=0;i<first;i++) calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=last;d++){
    const key=`${y}-${m}-${d}`;
    const div=document.createElement("div");
    div.className="day";
    div.innerHTML=`<b>${d}</b><div class="shift">${
      (shifts[key]||[]).map((s,i)=>{
        const money=calcDayMoney(key,s.name);
        return `${s.name}：${s.start}〜${s.end}`+
        (s.breakStart?`（休憩 ${s.breakStart}〜${s.breakEnd}）`:"")+
        (money>0 && s.name!=="社員"?`\n<span class="bold">${money}円</span>`:"")+
        `<br><button onclick="editShift('${key}',${i})">編集</button>`+
        `<button onclick="deleteShift('${key}',${i})">削除</button>`;
      }).join("<hr>")
    }</div>`;
    div.onclick=()=>openModal(key);
    calendar.appendChild(div);
  }
  calcMonthTotal();
}

function openModal(date){
  selectedDate=date;
  modal.style.display="flex";
  modalDate.textContent=date;
  editIndex=null;
  updateNameSelect();
}

function closeModal(){
  modal.style.display="none";
  document.querySelectorAll("input").forEach(i=>i.value="");
}

function updateNameSelect(){
  nameSelect.innerHTML='<option value="">選択してください</option>';
  names.forEach(n=>nameSelect.add(new Option(n,n)));
}

function saveShift(){
  let name=newName.value||nameSelect.value;
  if(!name)return;

  if(newName.value && !names.includes(newName.value)){
    names.push(newName.value);
    localStorage.setItem("names",JSON.stringify(names));
  }

  if(!shifts[selectedDate]) shifts[selectedDate]=[];
  const obj={
    name,start:start.value,end:end.value,
    breakStart:breakStart.value,breakEnd:breakEnd.value
  };

  if(editIndex!==null) shifts[selectedDate][editIndex]=obj;
  else shifts[selectedDate].push(obj);

  localStorage.setItem("shifts",JSON.stringify(shifts));
  closeModal();
  render();
}

function editShift(date,i){
  event.stopPropagation();
  openModal(date);
  const s=shifts[date][i];
  editIndex=i;
  nameSelect.value=s.name;
  start.value=s.start;
  end.value=s.end;
  breakStart.value=s.breakStart;
  breakEnd.value=s.breakEnd;
}

function deleteShift(date,i){
  event.stopPropagation();
  shifts[date].splice(i,1);
  localStorage.setItem("shifts",JSON.stringify(shifts));
  render();
}

function deleteName(){
  const n=nameSelect.value;
  if(n==="社員"||!n)return;
  names=names.filter(x=>x!==n);
  localStorage.setItem("names",JSON.stringify(names));
  updateNameSelect();
}

function timeToMin(t){
  const[a,b]=t.split(":").map(Number);
  return a*60+b;
}

function calcDayMoney(date,name){
  if(name==="社員") return 0;
  const dayShifts=shifts[date]||[];
  const target=dayShifts.filter(s=>s.name===name)[0];
  if(!target) return 0;

  let start=Math.max(timeToMin(target.start),615);
  let end=Math.min(timeToMin(target.end),1320);
  if(start>=end) return 0;

  if(target.breakStart){
    const bs=timeToMin(target.breakStart);
    const be=timeToMin(target.breakEnd);
    end-=Math.max(0,Math.min(end,be)-Math.max(start,bs));
  }

  let money=0;
  for(let t=start;t<end;t++){
    const working=dayShifts.filter(s=>{
      if(s.name==="社員"){
        const st=timeToMin(s.start),en=timeToMin(s.end);
        return t>=st && t<en;
      }
      return false;
    });
    if(working.length>0) continue;

    const others=dayShifts.filter(s=>{
      if(s.name===name||s.name==="社員")return false;
      const st=timeToMin(s.start),en=timeToMin(s.end);
      return t>=st && t<en;
    });
    money+=others.length>=1?100/60:200/60;
  }
  return Math.floor(money);
}

function calcMonthTotal(){
  const y=year.value, m=month.value;
  const total={};
  for(const d in shifts){
    if(!d.startsWith(`${y}-${m}-`))continue;
    shifts[d].forEach(s=>{
      if(s.name==="社員")return;
      total[s.name]=(total[s.name]||0)+calcDayMoney(d,s.name);
    });
  }
  totalDiv.textContent="月合計：\n"+Object.entries(total)
    .map(([n,v])=>`${n}：${v}円`).join("\n");
}

render();
</script>

</body>
</html>