<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body { font-family: sans-serif; padding: 20px; }
h1 { text-align: center; font-size: 28px; margin-bottom:10px; }
#ym { text-align:center; font-size:20px; margin-bottom:10px; }
#ym select { font-size:18px; margin:0 5px; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.day { border:1px solid #ccc; min-height:120px; padding:4px; cursor:pointer; position:relative; }
.weekday { text-align:center; font-weight:bold; font-size:14px; margin-bottom:2px; }
.day-number { font-weight:bold; font-size:14px; }
.shift { font-size:12px; white-space:pre-line; }
.total { font-size:12px; font-weight:bold; margin-top:2px; }
#modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); justify-content:center; align-items:center; }
#modalContent { background:#fff; width:340px; padding:15px; }
#monthly { margin-top:10px; font-size:16px; font-weight:bold; }
#nameSelect { width:160px; font-size:14px; }
</style>
</head>
<body>

<h1>自責計算</h1>

<div id="ym">
  <select id="year"></select>年
  <select id="month"></select>月
</div>

<div id="calendar"></div>
<div id="monthly"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    名前：
    <select id="nameSelect"><option value="">選択してください</option></select>
    <button onclick="deleteName()">名前削除</button><br><br>
    新しい名前：<input id="newName"><br><br>
    出勤：<input type="time" id="start"><br>
    退勤：<input type="time" id="end"><br>
    休憩開始：<input type="time" id="breakStart">〜<input type="time" id="breakEnd"><br><br>
    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">閉じる</button>
  </div>
</div>

<script>
let shifts = JSON.parse(localStorage.getItem("shifts")||"{}");
let names = JSON.parse(localStorage.getItem("names")||[]);
let selectedDate = "";

const yearSel = document.getElementById("year");
const monthSel = document.getElementById("month");
const now = new Date();
for(let y=2024;y<=2030;y++){ yearSel.add(new Option(y,y)); if(y===now.getFullYear()) yearSel.value=y; }
for(let m=1;m<=12;m++){ monthSel.add(new Option(m,m)); if(m===now.getMonth()+1) monthSel.value=m; }

yearSel.onchange = monthSel.onchange = renderCalendar;

function renderCalendar(){
  const y=+yearSel.value, m=+monthSel.value;
  const cal = document.getElementById("calendar");
  cal.innerHTML="";
  const w=["日","月","火","水","木","金","土"];

  // 曜日行
  w.forEach(d=>{ let div=document.createElement("div"); div.className="weekday"; div.textContent=d; cal.appendChild(div); });

  const first=new Date(y,m-1,1).getDay();
  const last=new Date(y,m,0).getDate();
  for(let i=0;i<first;i++) cal.appendChild(document.createElement("div"));

  for(let d=1; d<=last; d++){
    const key=`${y}-${m}-${d}`;
    const div=document.createElement("div");
    div.className="day";
    div.onclick=()=>openModal(key);
    div.innerHTML=`<div class="day-number">${d}</div>`;
    if(shifts[key]){
      const daily=calcDaily(key);
      shifts[key].forEach((s,i)=>{
        const bt = s.breakStart && s.breakEnd ? `（休憩 ${s.breakStart}〜${s.breakEnd}）` : '';
        div.innerHTML+=`<div class="shift">${s.name}：${s.start}〜${s.end}${bt} <button onclick="event.stopPropagation();editShift('${key}',${i})">編集</button> <button onclick="event.stopPropagation();removeShift('${key}',${i})">×</button></div>`;
      });
      for(const n in daily){
        if(daily[n]>0) div.innerHTML+=`<div class="total">${n}：${Math.floor(daily[n])}円</div>`;
      }
    }
    cal.appendChild(div);
  }
  renderMonthly();
}

function openModal(date){
  selectedDate=date;
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalDate").textContent=date;
  updateNameSelect();
}

function closeModal(){
  document.getElementById("modal").style.display="none";
  document.getElementById("newName").value="";
  document.getElementById("start").value="";
  document.getElementById("end").value="";
  document.getElementById("breakStart").value="";
  document.getElementById("breakEnd").value="";
}

function updateNameSelect(){
  const sel=document.getElementById("nameSelect");
  sel.innerHTML='<option value="">選択してください</option>';
  names.forEach(n=>{ sel.add(new Option(n,n)); });
}

function saveShift(){
  let name=document.getElementById("nameSelect").value;
  const newName=document.getElementById("newName").value.trim();
  if(newName){ name=newName; if(!names.includes(newName)) names.push(newName); }
  if(!name) return alert("名前を選択してください");
  localStorage.setItem("names",JSON.stringify(names));

  if(!shifts[selectedDate]) shifts[selectedDate]=[];
  const start=document.getElementById("start").value;
  const end=document.getElementById("end").value;
  const breakStart=document.getElementById("breakStart").value;
  const breakEnd=document.getElementById("breakEnd").value;
  shifts[selectedDate].push({name,start,end,breakStart,breakEnd});
  localStorage.setItem("shifts",JSON.stringify(shifts));
  closeModal();
  renderCalendar();
}

function deleteName(){
  const sel=document.getElementById("nameSelect");
  const name=sel.value;
  if(!name) return;
  if(!confirm(`名前 ${name} を削除しますか？`)) return;
  names=names.filter(n=>n!==name);
  localStorage.setItem("names",JSON.stringify(names));
  updateNameSelect();
}

function removeShift(date,index){
  shifts[date].splice(index,1);
  if(shifts[date].length===0) delete shifts[date];
  localStorage.setItem("shifts",JSON.stringify(shifts));
  renderCalendar();
}

function editShift(date,index){
  openModal(date);
  const s=shifts[date][index];
  document.getElementById("nameSelect").value=s.name;
  document.getElementById("start").value=s.start;
  document.getElementById("end").value=s.end;
  document.getElementById("breakStart").value=s.breakStart||"";
  document.getElementById("breakEnd").value=s.breakEnd||"";
  removeShift(date,index);
}

function calcDaily(date){
  const res={};
  const timeline=Array(1440).fill(0);
  const who=Array(1440).fill(null).map(()=>[]);
  if(!shifts[date]) return res;
  shifts[date].forEach(s=>{
    const [sh,sm]=s.start.split(":").map(Number);
    const [eh,em]=s.end.split(":").map(Number);
    const bs=s.breakStart? s.breakStart.split(":").map(Number):null;
    const be=s.breakEnd? s.breakEnd.split(":").map(Number):null;
    for(let t=sh*60+sm;t<eh*60+em;t++){
      if(bs && t>=bs[0]*60+bs[1] && t<be[0]*60+be[1]) continue;
      timeline[t]++;
      who[t].push(s.name);
    }
  });
  timeline.forEach((c,i)=>{
    if(!c) return;
    let per=(c===1)?200/60:100/60;
    // 社員がいる時間帯は0円
    if(who[i].includes("社員")) per=0;
    who[i].forEach(n=>{
      if(n==="社員") return;
      res[n]=(res[n]||0)+per;
    });
  });
  return res;
}

function renderMonthly(){
  const y=yearSel.value, m=monthSel.value;
  const total={};
  for(const date in shifts){
    if(!date.startsWith(`${y}-${m}-`)) continue;
    const daily=calcDaily(date);
    for(const n in daily){
      total[n]=(total[n]||0)+daily[n];
    }
  }
  const div=document.getElementById("monthly");
  div.innerHTML="月合計：<br>"+Object.entries(total).map(([n,v])=>`${n}：${Math.floor(v)}円`).join("<br>");
}

renderCalendar();
</script>
</body>
</html>