<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>自責計算</title>
<style>
body { font-family: sans-serif; }
h1 { text-align: center; }
header { text-align: center; margin-bottom: 10px; }
header select { font-size: 20px; }
#calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.weekday { text-align: center; font-weight: bold; }
.day { border: 1px solid #aaa; min-height: 120px; padding: 4px; cursor: pointer; }
.day-number { font-weight: bold; }
.shift { font-size: 12px; white-space: pre-line; }
#modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; }
#modalContent { background: #fff; padding: 15px; width: 340px; }
#total { margin-top: 10px; font-size: 18px; white-space: pre-line; }
select.small { width: 220px; }
</style>
</head>
<body>

<h1>自責計算</h1>

<header>
  <select id="year"></select> 年
  <select id="month"></select> 月
</header>

<div id="calendar"></div>
<div id="total"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>

    名前：
    <select id="nameSelect" class="small"></select><br><br>

    新しい名前：<input id="newName"><br><br>

    出勤：<input type="time" id="start"><br>
    退勤：<input type="time" id="end"><br>
    休憩開始：<input type="time" id="breakStart"><br>
    休憩終了：<input type="time" id="breakEnd"><br><br>

    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">閉じる</button>
  </div>
</div>

<script>
const shifts = JSON.parse(localStorage.getItem('shifts') || '{}');
let names = JSON.parse(localStorage.getItem('names') || '["社員"]');
let selectedDate = '';

const yearSel = document.getElementById('year');
const monthSel = document.getElementById('month');

for (let y = 2024; y <= 2030; y++) yearSel.add(new Option(y, y));
for (let m = 1; m <= 12; m++) monthSel.add(new Option(m, m));

yearSel.value = new Date().getFullYear();
monthSel.value = new Date().getMonth() + 1;

yearSel.onchange = monthSel.onchange = render;

function minutes(t) {
  const [h,m] = t.split(':').map(Number);
  return h*60+m;
}

function calcPay(date) {
  const list = shifts[date] || [];
  const staff = list.filter(s => s.name !== '社員');
  const emp = list.find(s => s.name === '社員');

  const pay = {};
  staff.forEach(s => pay[s.name] = 0);

  for (let min = minutes('10:15'); min < minutes('22:00'); min++) {
    const workingEmp = emp && min >= minutes(emp.start) && min < minutes(emp.end);
    if (workingEmp) continue;

    const active = staff.filter(s => {
      if (min < minutes(s.start) || min >= minutes(s.end)) return false;
      if (s.breakStart && min >= minutes(s.breakStart) && min < minutes(s.breakEnd)) return false;
      return true;
    });

    if (active.length === 1) pay[active[0].name] += 200/60;
    if (active.length === 2) active.forEach(a => pay[a.name] += 100/60);
  }

  Object.keys(pay).forEach(k => pay[k] = Math.floor(pay[k]));
  return pay;
}

function render() {
  const y = +yearSel.value;
  const m = +monthSel.value;
  const first = new Date(y, m-1, 1).getDay();
  const last = new Date(y, m, 0).getDate();

  const cal = document.getElementById('calendar');
  cal.innerHTML = '';

  ['日','月','火','水','木','金','土'].forEach(w => {
    const d = document.createElement('div');
    d.className = 'weekday'; d.innerText = w; cal.appendChild(d);
  });

  for (let i=0;i<first;i++) cal.appendChild(document.createElement('div'));

  let monthTotal = {};

  for (let d=1; d<=last; d++) {
    const key = `${y}-${m}-${d}`;
    const div = document.createElement('div');
    div.className='day';

    const pays = calcPay(key);
    Object.entries(pays).forEach(([n,v]) => monthTotal[n]=(monthTotal[n]||0)+v);

    div.innerHTML = `<div class='day-number'>${d}</div><div class='shift'>${(shifts[key]||[]).map(s=>
      s.name==='社員'
        ? `${s.name}：${s.start}〜${s.end}`
        : `${s.name}：${s.start}〜${s.end}${s.breakStart?`（休憩${s.breakStart}〜${s.breakEnd}）`:''}${pays[s.name]?`\n${s.name}：${pays[s.name]}円`:''}`
    ).join('\n')}</div>`;

    div.onclick=()=>openModal(key);
    cal.appendChild(div);
  }

  document.getElementById('total').innerText = '月合計\n'+Object.entries(monthTotal).map(([n,v])=>`${n}：${v}円`).join('\n');
}

function openModal(date){
  selectedDate=date;
  document.getElementById('modal').style.display='flex';
  document.getElementById('modalDate').innerText=date;
  updateNameSelect();
}

function closeModal(){
  document.getElementById('modal').style.display='none';
  document.querySelectorAll('#modalContent input').forEach(i=>i.value='');
}

function updateNameSelect(){
  const sel=document.getElementById('nameSelect');
  sel.innerHTML='';
  sel.add(new Option('選択してください',''));
  names.forEach(n=>sel.add(new Option(n,n)));
}

function saveShift(){
  const name=newName.value||nameSelect.value;
  if(!name)return;
  if(!names.includes(name)){
    names.push(name);
    localStorage.setItem('names',JSON.stringify(names));
  }
  if(!shifts[selectedDate])shifts[selectedDate]=[];
  shifts[selectedDate].push({
    name,
    start:start.value,
    end:end.value,
    breakStart:breakStart.value,
    breakEnd:breakEnd.value
  });
  localStorage.setItem('shifts',JSON.stringify(shifts));
  closeModal();
  render();
}

render();
</script>
</body>
</html>
