<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body{font-family:sans-serif;margin:10px}
h1{text-align:center}
header{text-align:center;margin-bottom:10px}
select{font-size:20px}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.day{border:1px solid #ccc;min-height:130px;padding:4px;cursor:pointer;font-size:12px}
.day-number{font-weight:bold}
.shift{white-space:pre-line}
.money{font-weight:bold}
#total{margin-top:10px;font-size:18px}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
#modalContent{background:#fff;padding:15px;width:320px}
.row{margin-bottom:6px}
button{margin-right:5px}
</style>
</head>
<body>
<h1>自責計算</h1>
<header>
<select id="year"></select>年
<select id="month"></select>月
</header>
<div id="calendar"></div>
<div id="total"></div>

<div id="modal">
 <div id="modalContent">
  <h3 id="modalDate"></h3>
  <div class="row">名前：
   <select id="nameSelect" style="width:200px">
    <option value="">選択してください</option>
   </select>
   <button onclick="deleteName()">名前削除</button>
  </div>
  <div class="row">新しい名前：<input id="newName"></div>
  <div class="row">出勤：<input type="time" id="start"></div>
  <div class="row">退勤：<input type="time" id="end"></div>
  <div class="row">休憩開始：<input type="time" id="breakStart"></div>
  <div class="row">休憩終了：<input type="time" id="breakEnd"></div>
  <button onclick="save()">保存</button>
  <button onclick="closeModal()">閉じる</button>
 </div>
</div>

<script>
const shifts=JSON.parse(localStorage.getItem('shifts')||'{}');
let names=JSON.parse(localStorage.getItem('names')||'["社員"]');
let editIndex=null;
let selectedDate='';

const ySel=year.value,mSel=month.value;
for(let y=2024;y<=2030;y++)year.add(new Option(y,y));
for(let m=1;m<=12;m++)month.add(new Option(m,m));
year.value=new Date().getFullYear();
month.value=new Date().getMonth()+1;
year.onchange=month.onchange=render;

function render(){
 const y=+year.value,m=+month.value;
 calendar.innerHTML='';
 const first=new Date(y,m-1,1).getDay();
 const last=new Date(y,m,0).getDate();
 const week=['日','月','火','水','木','金','土'];
 week.forEach(w=>{const d=document.createElement('div');d.textContent=w;calendar.appendChild(d)});
 for(let i=0;i<first;i++)calendar.appendChild(document.createElement('div'));
 for(let d=1;d<=last;d++){
  const key=`${y}-${m}-${d}`;
  const div=document.createElement('div');div.className='day';
  let txt='';
  (shifts[key]||[]).forEach((s,i)=>{
   txt+=`${s.name}：${s.start}~${s.end}${s.break?'（休憩 '+s.break+'）':''}\n`;
   if(s.money>0)txt+=`\n${s.name}：`+`<span class="money">${s.money}円</span>\n`;
   txt+=`[編集] [削除]\n`;
  });
  div.innerHTML=`<div class="day-number">${d}</div><div class="shift">${txt}</div>`;
  div.onclick=()=>openModal(key);
  calendar.appendChild(div);
 }
 calcMonthTotal();
}

function openModal(date){selectedDate=date;editIndex=null;modal.style.display='flex';modalDate.textContent=date;updateNames()}
function closeModal(){modal.style.display='none';['newName','start','end','breakStart','breakEnd'].forEach(id=>document.getElementById(id).value='');nameSelect.value='';}

function updateNames(){nameSelect.innerHTML='<option value="">選択してください</option>';names.forEach(n=>nameSelect.add(new Option(n,n)))}

function calcPay(date){
 const list=shifts[date]||[];
 const times=[];
 list.forEach(s=>{
  if(s.name==='社員')times.push([s.start,s.end,'社員']);
  else times.push([s.start,s.end,s.name]);
 });
 const pay={};
 list.forEach(s=>pay[s.name]=0);
 for(let h=10*60+15;h<22*60;h++){
  const active=list.filter(s=>h>=toMin(s.start)&&h<toMin(s.end)&&!(s.break&&h>=toMin(s.break.split('〜')[0])&&h<toMin(s.break.split('〜')[1])));
  if(active.some(s=>s.name==='社員'))continue;
  if(active.length===1)pay[active[0].name]+=200/60;
  if(active.length===2)active.forEach(s=>pay[s.name]+=100/60);
 }
 Object.keys(pay).forEach(n=>pay[n]=Math.floor(pay[n]));
 return pay;
}

function save(){
 const name=newName.value||nameSelect.value;
 if(!name)return;
 if(newName.value&&!names.includes(newName.value)){names.push(newName.value);localStorage.setItem('names',JSON.stringify(names))}
 if(!shifts[selectedDate])shifts[selectedDate]=[];
 shifts[selectedDate].push({name,start:start.value,end:end.value,break:breakStart.value&&breakEnd.value?`${breakStart.value}〜${breakEnd.value}`:'',money:0});
 const pay=calcPay(selectedDate);
 shifts[selectedDate].forEach(s=>s.money=pay[s.name]||0);
 localStorage.setItem('shifts',JSON.stringify(shifts));
 closeModal();render();
}

function deleteName(){const n=nameSelect.value;if(!n||n==='社員')return;names=names.filter(x=>x!==n);localStorage.setItem('names',JSON.stringify(names));updateNames()}

function toMin(t){const[a,b]=t.split(':').map(Number);return a*60+b}

function calcMonthTotal(){
 const y=year.value,m=month.value;const sum={};
 for(const d in shifts){if(!d.startsWith(`${y}-${m}-`))continue;shifts[d].forEach(s=>{if(s.name!=='社員')sum[s.name]=(sum[s.name]||0)+s.money})}
 total.textContent='月合計：\n'+Object.entries(sum).map(([n,v])=>`${n}：${v}円`).join('\n');
}

render();
</script>
</body>
</html>