<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>自責計算</title>
<style>
body { font-family: sans-serif; }
h1 { text-align:center; }
header { text-align:center; margin:10px; }
header select { font-size:22px; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.week { text-align:center; font-weight:bold; }
.day { border:1px solid #ccc; min-height:130px; padding:4px; cursor:pointer; }
.day-number { font-weight:bold; }
.shift { font-size:12px; margin-top:2px; white-space:pre-line; }
.money { font-weight:bold; }
#total { margin-top:15px; font-size:18px; }
#modal { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; justify-content:center; align-items:center; }
#modalContent { background:#fff; padding:15px; width:320px; }
.row { margin-bottom:6px; }
.row select { width:180px; }
.buttons { display:flex; gap:10px; }
</style>
</head>
<body>
<h1>自責計算</h1>
<header>
<select id="year"></select> 年
<select id="month"></select> 月
</header>
<div id="calendar"></div>
<div id="total"></div>

<div id="modal">
 <div id="modalContent">
  <h3 id="modalDate"></h3>
  <div class="row">名前：
   <select id="nameSelect">
    <option value="">選択してください</option>
   </select>
  </div>
  <div class="row">新しい名前：<input id="newName" /></div>
  <div class="row">出勤：<input type="time" id="start" /></div>
  <div class="row">退勤：<input type="time" id="end" /></div>
  <div class="row">休憩開始：<input type="time" id="breakStart" /></div>
  <div class="row">休憩終了：<input type="time" id="breakEnd" /></div>
  <div class="buttons">
   <button onclick="save()">保存</button>
   <button onclick="closeModal()">閉じる</button>
  </div>
 </div>
</div>

<script>
const shifts = JSON.parse(localStorage.getItem('shifts')||'{}');
let names = JSON.parse(localStorage.getItem('names')||'["社員"]');
let selectedDate="";
let editIndex=null;

const yearSel=document.getElementById('year');
const monthSel=document.getElementById('month');
for(let y=2024;y<=2030;y++) yearSel.add(new Option(y,y));
for(let m=1;m<=12;m++) monthSel.add(new Option(m,m));
const now=new Date();
yearSel.value=now.getFullYear(); monthSel.value=now.getMonth()+1;

yearSel.onchange=monthSel.onchange=render;

function timeToMin(t){const[a,b]=t.split(':');return +a*60+ +b;}

function calcPay(date){
 const list=shifts[date]||[];
 const events=[];
 list.forEach(s=>{
  if(s.name==='社員'){
   events.push([timeToMin(s.start), timeToMin(s.end), '社員']);
  } else {
   events.push([timeToMin(s.start), timeToMin(s.end), s.name]);
  }
 });
 const persons=list.filter(s=>s.name!=='社員').map(s=>s.name);
 const pay={}; persons.forEach(p=>pay[p]=0);
 const times=[];
 events.forEach(e=>{times.push(e[0],e[1]);});
 times.sort((a,b)=>a-b);
 for(let i=0;i<times.length-1;i++){
  const t1=times[i], t2=times[i+1];
  if(t2<=t1) continue;
  if(t2<=timeToMin('10:15')||t1>=timeToMin('22:00')) continue;
  const mid=(t1+t2)/2;
  const working=list.filter(s=>s.name!=='社員'&&timeToMin(s.start)<=mid&&timeToMin(s.end)>mid);
  const staff=list.some(s=>s.name==='社員'&&timeToMin(s.start)<=mid&&timeToMin(s.end)>mid);
  if(staff||working.length===0) continue;
  const rate=working.length===1?200:100;
  working.forEach(s=>{ pay[s.name]+=rate*(t2-t1)/60; });
 }
 Object.keys(pay).forEach(k=>pay[k]=Math.floor(pay[k]));
 return pay;
}

function render(){
 const y=+yearSel.value, m=+monthSel.value;
 const cal=document.getElementById('calendar'); cal.innerHTML='';
 ['日','月','火','水','木','金','土'].forEach(w=>{
  const d=document.createElement('div'); d.className='week'; d.textContent=w; cal.appendChild(d);
 });
 const first=new Date(y,m-1,1).getDay();
 const last=new Date(y,m,0).getDate();
 for(let i=0;i<first;i++) cal.appendChild(document.createElement('div'));
 for(let d=1;d<=last;d++){
  const key=`${y}-${m}-${d}`;
  const div=document.createElement('div'); div.className='day';
  const pay=calcPay(key);
  div.innerHTML=`<div class="day-number">${d}</div>`;
  (shifts[key]||[]).forEach((s,i)=>{
   const line=`${s.name}：${s.start}~${s.end}${s.break?`（休憩 ${s.break}）`:''}`;
   const money=pay[s.name]?`\n${pay[s.name]}円`:'';
   div.innerHTML+=`<div class="shift">${line}${money?`\n<span class='money'>${money}</span>`:''}
   <br><button onclick="edit('${key}',${i});event.stopPropagation()">編集</button>
   <button onclick="del('${key}',${i});event.stopPropagation()">削除</button></div>`;
  });
  div.onclick=()=>openModal(key);
  cal.appendChild(div);
 }
 calcMonthTotal();
}

function openModal(date){selectedDate=date;editIndex=null;modal.style.display='flex';modalDate.textContent=date;updateNames();}
function closeModal(){modal.style.display='none';['newName','start','end','breakStart','breakEnd'].forEach(id=>document.getElementById(id).value='');nameSelect.value='';}
function updateNames(){nameSelect.innerHTML='<option value="">選択してください</option>';names.forEach(n=>nameSelect.add(new Option(n,n)));}

function save(){
 const name=newName.value||nameSelect.value; if(!name) return;
 if(newName.value&&!names.includes(newName.value)){names.push(newName.value);localStorage.setItem('names',JSON.stringify(names));}
 if(!shifts[selectedDate]) shifts[selectedDate]=[];
 const obj={name,start:start.value,end:end.value,break:(breakStart.value&&breakEnd.value)?`${breakStart.value}~${breakEnd.value}`:''};
 if(editIndex!==null) shifts[selectedDate][editIndex]=obj; else shifts[selectedDate].push(obj);
 localStorage.setItem('shifts',JSON.stringify(shifts)); closeModal(); render();
}

function edit(date,i){const s=shifts[date][i];openModal(date);editIndex=i;nameSelect.value=s.name;start.value=s.start;end.value=s.end;if(s.break){[breakStart.value,breakEnd.value]=s.break.split('~');}}
function del(date,i){if(!confirm('削除しますか？'))return;shifts[date].splice(i,1);localStorage.setItem('shifts',JSON.stringify(shifts));render();}

function calcMonthTotal(){const y=yearSel.value,m=monthSel.value;const total={};
 for(const d in shifts){if(!d.startsWith(`${y}-${m}-`))continue;const p=calcPay(d);for(const n in p) total[n]=(total[n]||0)+p[n];}
 totalDiv.innerHTML='月合計：<br>'+Object.entries(total).map(([n,v])=>`${n}：${v}円`).join('<br>');}

render();
</script>
</body>
</html>