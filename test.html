<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>自責計算</title>
<style>
body { font-family: sans-serif; }
h1 { text-align:center; }
header { text-align:center; margin-bottom:10px; }
header select { font-size:22px; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.week { text-align:center; font-weight:bold; }
.day { border:1px solid #ccc; min-height:130px; padding:4px; cursor:pointer; }
.day-number { font-weight:bold; }
.shift { font-size:12px; white-space:pre-line; }
button { margin:2px; }
#modal { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; }
#modalContent { background:#fff; padding:15px; width:320px; }
#total { margin-top:15px; font-weight:bold; white-space:pre-line; }
select[name=name] { width:200px; }
</style>
</head>
<body>

<h1>自責計算</h1>

<header>
<select id="year"></select> 年
<select id="month"></select> 月
</header>

<div id="calendar"></div>

<div id="total"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    名前：
    <select id="nameSelect" name="name"></select><br><br>
    新しい名前：<input id="newName"><br><br>
    出勤：<input type="time" id="start"><br>
    退勤：<input type="time" id="end"><br>
    休憩開始：<input type="time" id="breakStart"><br>
    休憩終了：<input type="time" id="breakEnd"><br><br>
    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">閉じる</button>
  </div>
</div>

<script>
const RATE = 200;
const START_PAY = 615; // 10:15
const END_PAY = 1320; // 22:00

let shifts = JSON.parse(localStorage.getItem('shifts')||'{}');
let names = JSON.parse(localStorage.getItem('names')||'["社員"]');
let editTarget = null;
let selectedDate = '';

const yearSel=document.getElementById('year');
const monthSel=document.getElementById('month');
for(let y=2024;y<=2030;y++)yearSel.add(new Option(y,y));
for(let m=1;m<=12;m++)monthSel.add(new Option(m,m));
yearSel.value=new Date().getFullYear();
monthSel.value=new Date().getMonth()+1;
yearSel.onchange=monthSel.onchange=render;

function minutes(t){ if(!t)return null; const[a,b]=t.split(':'); return +a*60+ +b; }

function render(){
  const y=+yearSel.value,m=+monthSel.value;
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  ['月','火','水','木','金','土','日'].forEach(w=>{
    const d=document.createElement('div');d.className='week';d.textContent=w;cal.appendChild(d);
  });
  const first=new Date(y,m-1,1).getDay();
  const start=(first+6)%7;
  const last=new Date(y,m,0).getDate();
  for(let i=0;i<start;i++)cal.appendChild(document.createElement('div'));
  for(let d=1;d<=last;d++){
    const key=`${y}-${m}-${d}`;
    const box=document.createElement('div');box.className='day';
    box.innerHTML=`<div class=day-number>${d}</div>`;
    const list=shifts[key]||[];
    list.forEach((s,i)=>{
      const line=document.createElement('div');line.className='shift';
      const time=`${s.start}~${s.end}`+(s.break?`（休憩${s.break}）`:'' );
      const money=s.money>0?`\n${s.money}円`:'';
      line.textContent=`${s.name}：${time}${money}`;
      const edit=document.createElement('button');edit.textContent='編集';edit.onclick=e=>{e.stopPropagation();openModal(key,i);};
      const del=document.createElement('button');del.textContent='削除';del.onclick=e=>{e.stopPropagation();removeShift(key,i);};
      line.appendChild(edit);line.appendChild(del);
      box.appendChild(line);
    });
    box.onclick=()=>openModal(key);
    cal.appendChild(box);
  }
  calcMonthTotal();
}

function openModal(date,index=null){
  selectedDate=date; editTarget=index;
  document.getElementById('modal').style.display='flex';
  document.getElementById('modalDate').textContent=date;
  updateNameSelect();
  document.querySelectorAll('#modalContent input').forEach(i=>i.value='');
  if(index!==null){
    const s=shifts[date][index];
    nameSelect.value=s.name;
    start.value=s.start; end.value=s.end;
    if(s.break){const[b1,b2]=s.break.split('~');breakStart.value=b1;breakEnd.value=b2;}
  }
}
function closeModal(){document.getElementById('modal').style.display='none';}

function updateNameSelect(){
  nameSelect.innerHTML='<option value="">選択してください</option>';
  names.forEach(n=>nameSelect.add(new Option(n,n)));
}

function saveShift(){
  let name=newName.value||nameSelect.value;
  if(!name)return;
  if(newName.value && !names.includes(name)){
    names.push(name);
    localStorage.setItem('names',JSON.stringify(names));
  }
  const s={name,start:start.value,end:end.value,break:(breakStart.value&&breakEnd.value)?`${breakStart.value}~${breakEnd.value}`:'',money:0};
  if(!shifts[selectedDate])shifts[selectedDate]=[];
  if(editTarget!==null)shifts[selectedDate][editTarget]=s; else shifts[selectedDate].push(s);
  calculateDay(selectedDate);
  localStorage.setItem('shifts',JSON.stringify(shifts));
  closeModal(); render();
}

function removeShift(date,i){ if(confirm('削除しますか？')){ shifts[date].splice(i,1); localStorage.setItem('shifts',JSON.stringify(shifts)); render(); } }

function calculateDay(date){
  const list=shifts[date]; if(!list)return;
  list.forEach(s=>s.money=0);
  for(let min=START_PAY;min<END_PAY;min++){
    const active=list.filter(s=>{
      const st=minutes(s.start),ed=minutes(s.end);
      if(min<st||min>=ed)return false;
      if(s.break){const[b1,b2]=s.break.split('~').map(minutes); if(min>=b1&&min<b2)return false;}
      return true;
    });
    if(active.find(a=>a.name==='社員'))continue;
    if(active.length===1)active[0].money+=RATE/60;
    if(active.length===2)active.forEach(a=>a.money+=RATE/120);
  }
  list.forEach(s=>s.money=Math.floor(s.money));
}

function calcMonthTotal(){
  const y=yearSel.value,m=monthSel.value;
  const sum={};
  for(const d in shifts){ if(!d.startsWith(`${y}-${m}-`))continue; shifts[d].forEach(s=>{ if(s.name!=='社員') sum[s.name]=(sum[s.name]||0)+s.money; }); }
  document.getElementById('total').textContent='月合計\n'+Object.entries(sum).map(([n,v])=>`${n}：${v}円`).join('\n');
}

render();
</script>
</body>
</html>