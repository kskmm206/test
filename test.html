<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自責計算</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { text-align:center; }
    .ym { text-align:center; font-size:26px; margin-bottom:10px; }
    select { font-size:20px; }

    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
    .day { border:1px solid #ccc; min-height:140px; padding:4px; cursor:pointer; }
    .weekday { text-align:center; font-weight:bold; font-size:12px; }
    .date { font-weight:bold; }
    .shift { font-size:11px; margin-top:3px; }
    .money { font-size:11px; font-weight:bold; }

    #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); }
    #modalContent { background:#fff; width:340px; margin:80px auto; padding:15px; }

    #monthly { margin-top:20px; font-size:20px; font-weight:bold; }
    button { margin:2px; }
  </style>
</head>
<body>
<h1>自責計算</h1>

<div class="ym">
  <select id="year"></select> 年
  <select id="month"></select> 月
</div>

<div class="calendar" id="calendar"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    名前
    <select id="name"></select><br>
    出勤 <input id="start" type="time"><br>
    退勤 <input id="end" type="time"><br>
    休憩 <input id="breakStart" type="time">〜<input id="breakEnd" type="time"><br><br>
    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">キャンセル</button>
  </div>
</div>

<div id="monthly"></div>

<script>
/* ===== localStorage ===== */
function load(key, def){ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let shifts = load('shifts', []);
let names = load('names', ['社員']);
let selectedDate = null;
let editIndex = null;

/* ===== 年月 ===== */
const yearSel = document.getElementById('year');
const monthSel = document.getElementById('month');
const now = new Date();
for(let y=2024;y<=2028;y++){
  yearSel.innerHTML += `<option ${y===now.getFullYear()?'selected':''}>${y}</option>`;
}
for(let m=1;m<=12;m++){
  monthSel.innerHTML += `<option ${m===now.getMonth()+1?'selected':''}>${m}</option>`;
}
yearSel.onchange = monthSel.onchange = renderCalendar;

/* ===== 名前 ===== */
function renderNameSelect(){
  name.innerHTML = '<option value="">選択してください</option>';
  names.forEach(n=>{
    name.innerHTML += `<option>${n}</option>`;
  });
}
renderNameSelect();

/* ===== カレンダー ===== */
function renderCalendar(){
  calendar.innerHTML='';
  const y=+yearSel.value, m=+monthSel.value;
  const first=new Date(y,m-1,1).getDay();
  const days=new Date(y,m,0).getDate();
  const w=['日','月','火','水','木','金','土'];

  for(let i=0;i<first;i++) calendar.appendChild(document.createElement('div'));

  for(let d=1;d<=days;d++){
    const date=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const box=document.createElement('div'); box.className='day';
    box.onclick=()=>openModal(date);
    box.innerHTML=`<div class='weekday'>${w[new Date(y,m-1,d).getDay()]}</div><div class='date'>${d}</div>`;

    shifts.filter(s=>s.date===date).forEach((s,i)=>{
      const bt=s.breakStart&&s.breakEnd?`（休憩 ${s.breakStart}〜${s.breakEnd}）`:'';
      box.innerHTML+=`
        <div class='shift'>
          ${s.name}：${s.start}〜${s.end}${bt}<br>
          <button onclick="event.stopPropagation();editShift('${date}',${i})">編集</button>
          <button onclick="event.stopPropagation();deleteShift('${date}',${i})">削除</button>
        </div>`;
      const money = calcDaily(date)[s.name];
      if(money && s.name!=='社員') box.innerHTML+=`<div class='money'>${Math.floor(money)}円</div>`;
    });
    calendar.appendChild(box);
  }
  renderMonthly();
}

/* ===== モーダル ===== */
function openModal(date){
  selectedDate=date; editIndex=null;
  modalDate.textContent=date;
  modal.style.display='block';
}
function closeModal(){
  modal.style.display='none';
  name.value=start.value=end.value=breakStart.value=breakEnd.value='';
}

/* ===== 保存 ===== */
function saveShift(){
  if(!name.value||!start.value||!end.value) return;
  const obj={date:selectedDate,name:name.value,start:start.value,end:end.value,breakStart:breakStart.value,breakEnd:breakEnd.value};
  if(editIndex!==null){ shifts[editIndex]=obj; }
  else shifts.push(obj);
  save('shifts',shifts);
  closeModal(); renderCalendar();
}

function editShift(date,i){
  const list=shifts.filter(s=>s.date===date);
  const s=list[i]; editIndex=shifts.indexOf(s);
  openModal(date);
  name.value=s.name; start.value=s.start; end.value=s.end;
  breakStart.value=s.breakStart||''; breakEnd.value=s.breakEnd||'';
}

function deleteShift(date,i){
  const list=shifts.filter(s=>s.date===date);
  shifts=shifts.filter(s=>s!==list[i]);
  save('shifts',shifts); renderCalendar();
}

/* ===== 給料計算 ===== */
function calcDaily(date){
  const res={};
  const t=Array(1440).fill([]).map(()=>[]);
  shifts.filter(s=>s.date===date).forEach(s=>{
    const sh=toMin(s.start), eh=toMin(s.end);
    const bs=s.breakStart?toMin(s.breakStart):null;
    const be=s.breakEnd?toMin(s.breakEnd):null;
    for(let i=sh;i<eh;i++){
      if(bs&&i>=bs&&i<be) continue;
      t[i].push(s.name);
    }
  });
  for(let i=0;i<1440;i++){
    if(i>615 && i<1320) continue;
    if(t[i].includes('社員')) continue;
    const n=t[i].length;
    if(n===0) continue;
    const per=(n===1?200:100)/60;
    t[i].forEach(nm=>res[nm]=(res[nm]||0)+per);
  }
  return res;
}
const toMin=t=>{const[a,b]=t.split(':').map(Number);return a*60+b;};

/* ===== 月合計 ===== */
function renderMonthly(){
  const y=yearSel.value, m=monthSel.value;
  const total={};
  shifts.filter(s=>s.date.startsWith(`${y}-${String(m).padStart(2,'0')}`)).forEach(s=>{
    const d=calcDaily(s.date);
    Object.entries(d).forEach(([n,v])=>total[n]=(total[n]||0)+v);
  });
  monthly.innerHTML='<h2>月合計</h2>';
  Object.entries(total).forEach(([n,v])=>monthly.innerHTML+=`<div>${n}：${Math.floor(v)}円</div>`);
}

renderCalendar();
</script>
</body>
</html>