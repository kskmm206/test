<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body { font-family: sans-serif; padding: 10px; }
h1 { text-align: center; margin-bottom: 10px; }
header { text-align:center; margin-bottom:10px; font-size:20px; }
select { font-size: 18px; margin:0 5px; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.day { border:1px solid #ccc; min-height:120px; padding:4px; cursor:pointer; position:relative; }
.weekday { text-align:center; font-weight:bold; background:#eee; }
.day-number { font-weight:bold; margin-bottom:2px; }
.shift { font-size:12px; margin:2px 0; white-space:pre-line; }
.total { font-size:12px; font-weight:bold; margin-top:4px; }
#modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); justify-content:center; align-items:center; }
#modalContent { background:#fff; padding:15px; width:320px; }
input, select { margin-bottom:4px; width:100%; box-sizing:border-box; }
button { margin-top:4px; }
#monthly { margin-top:15px; font-size:16px; font-weight:bold; white-space:pre-line; }
</style>
</head>
<body>

<h1>自責計算</h1>

<header>
<select id="year"></select> 年
<select id="month"></select> 月
</header>

<div id="calendar"></div>
<div id="monthly"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    名前：
    <select id="nameSelect"></select>
    <button onclick="deleteName()">名前削除</button><br><br>
    新しい名前：<input id="newName" placeholder="新しい名前を追加"><br>
    出勤：<input type="time" id="start"><br>
    退勤：<input type="time" id="end"><br>
    休憩開始：<input type="time" id="breakStart"><br>
    休憩終了：<input type="time" id="breakEnd"><br>
    <button onclick="saveShift()">保存</button>
    <button onclick="closeModal()">閉じる</button>
  </div>
</div>

<script>
/* ===== localStorage ===== */
let shifts = JSON.parse(localStorage.getItem("shifts")||"{}");
let names = JSON.parse(localStorage.getItem("names")||[]);
if(!names.includes("社員")) names.push("社員");
let selectedDate = "";

/* ===== 年月初期化 ===== */
const yearSel = document.getElementById("year");
const monthSel = document.getElementById("month");
const now = new Date();
for(let y=2024;y<=2030;y++) yearSel.add(new Option(y,y));
for(let m=1;m<=12;m++) monthSel.add(new Option(m,m));
yearSel.value = now.getFullYear();
monthSel.value = now.getMonth()+1;
yearSel.onchange = monthSel.onchange = renderCalendar;

/* ===== 名前セレクト ===== */
const nameSelect = document.getElementById("nameSelect");
const newNameInput = document.getElementById("newName");

/* ===== カレンダー描画 ===== */
function renderCalendar(){
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  const y = +yearSel.value;
  const m = +monthSel.value;
  const days = new Date(y,m,0).getDate();
  const firstDay = new Date(y,m-1,1).getDay();
  const w = ["日","月","火","水","木","金","土"];

  // 曜日ヘッダー
  for(let i=0;i<7;i++){
    const div = document.createElement("div");
    div.className="weekday";
    div.textContent = w[i];
    cal.appendChild(div);
  }

  for(let i=0;i<firstDay;i++) cal.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const dateStr = `${y}-${m}-${d}`;
    const div = document.createElement("div");
    div.className="day";
    div.onclick = ()=>openModal(dateStr);

    const dayShifts = shifts[dateStr]||[];
    let shiftText = "";
    dayShifts.forEach((s,i)=>{
      const bt = s.breakStart&&s.breakEnd ? `（休憩 ${s.breakStart}〜${s.breakEnd}）` : "";
      shiftText += `${s.name}：${s.start}〜${s.end}${bt}`;
      shiftText += "\n";
    });

    // 日ごとの報酬計算
    const daily = calcDaily(dateStr);
    let totalText = "";
    Object.entries(daily).forEach(([n,v])=>{
      if(v>0) totalText += `${n}：${Math.floor(v)}円\n`;
    });

    div.innerHTML = `<div class="day-number">${d}</div><div class="shift">${shiftText}${totalText}</div>`;
    cal.appendChild(div);
  }

  renderMonthly();
}

/* ===== モーダル ===== */
function openModal(date){
  selectedDate = date;
  document.getElementById("modalDate").textContent = date;
  updateNameSelect();
  document.getElementById("modal").style.display = "flex";
}
function closeModal(){
  document.getElementById("modal").style.display = "none";
  newNameInput.value = start.value = end.value = breakStart.value = breakEnd.value = "";
}

/* ===== 名前操作 ===== */
function updateNameSelect(){
  nameSelect.innerHTML="";
  nameSelect.add(new Option("選択してください",""));
  names.forEach(n=>nameSelect.add(new Option(n,n)));
}

function deleteName(){
  const name = nameSelect.value;
  if(!name) return;
  if(!confirm(`${name} を削除しますか？（シフトは残ります）`)) return;
  names = names.filter(n=>n!==name);
  localStorage.setItem("names",JSON.stringify(names));
  updateNameSelect();
}

/* ===== シフト保存 ===== */
function saveShift(){
  const name = newNameInput.value || nameSelect.value;
  if(!name || !start.value || !end.value) return;

  if(newNameInput.value && !names.includes(newNameInput.value)){
    names.push(newNameInput.value);
    localStorage.setItem("names",JSON.stringify(names));
  }

  if(!shifts[selectedDate]) shifts[selectedDate] = [];
  shifts[selectedDate].push({
    name,
    start:start.value,
    end:end.value,
    breakStart:breakStart.value,
    breakEnd:breakEnd.value
  });

  localStorage.setItem("shifts",JSON.stringify(shifts));
  closeModal();
  renderCalendar();
}

/* ===== 日報酬計算 ===== */
function calcDaily(date){
  const res={};
  const timeline=Array(24*60).fill(0);
  const who = Array(24*60).fill(null).map(()=>[]);

  (shifts[date]||[]).forEach(s=>{
    const [sh,sm]=s.start.split(":").map(Number);
    const [eh,em]=s.end.split(":").map(Number);
    const bs = s.breakStart?s.breakStart.split(":").map(Number):null;
    const be = s.breakEnd?s.breakEnd.split(":").map(Number):null;

    for(let t=sh*60+sm;t<eh*60+em;t++){
      if(bs && t>=bs[0]*60+bs[1] && t<be[0]*60+be[1]) continue;
      timeline[t]++;
      who[t].push(s.name);
    }
  });

  timeline.forEach((c,i)=>{
    const active = who[i];
    if(active.includes("社員")) return; // 社員がいる時間は報酬なし
    active.forEach(n=>{
      const per = (active.length===1)?200/60:100/60;
      res[n]=(res[n]||0)+per;
    });
  });

  return res;
}

/* ===== 月合計 ===== */
function renderMonthly(){
  const y = yearSel.value;
  const m = monthSel.value;
  const total = {};
  for(const date in shifts){
    if(!date.startsWith(`${y}-${m}-`)) continue;
    const daily = calcDaily(date);
    Object.entries(daily).forEach(([n,v])=>{
      total[n] = (total[n]||0)+v;
    });
  }
  const div = document.getElementById("monthly");
  div.innerText = Object.keys(total).length
    ? "月合計：\n"+Object.entries(total).map(([n,v])=>`${n}：${Math.floor(v)}円`).join("\n")
    : "";
}

/* ===== 初期表示 ===== */
renderCalendar();
</script>
</body>
</html>
