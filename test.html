<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>

<style>
body{font-family:sans-serif;padding:20px}
h1{text-align:center}

.ym{
 display:flex;
 justify-content:center;
 align-items:center;
 gap:6px;
 font-size:30px;
 margin:15px 0
}
.ym select{font-size:24px}

.calendar{
 display:grid;
 grid-template-columns:repeat(7,1fr);
 gap:4px
}
.header{font-weight:bold;text-align:center}
.day{
 border:1px solid #ccc;
 min-height:180px;
 padding:4px;
 cursor:pointer
}
.date{font-weight:bold;text-align:right}
.shift{font-size:12px;margin-top:2px}
.money{font-weight:bold;margin-top:2px}
.actions{display:flex;gap:4px;margin-top:2px}

#modal{
 display:none;
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4)
}
#modalContent{
 background:#fff;
 width:360px;
 margin:80px auto;
 padding:15px
}

.name-row{display:flex;gap:6px;align-items:center}
.name-row select{height:26px;width:260px}

#monthly{
 margin-top:20px;
 font-size:22px;
 font-weight:bold;
 text-align:center
}
</style>
</head>

<body>
<h1>自責計算</h1>

<div class="ym">
<select id="year"></select>年
<select id="month"></select>月
</div>

<div class="calendar" id="calendar"></div>

<div id="modal">
 <div id="modalContent">
  <h3 id="modalDate"></h3>

  <div class="name-row">
   <select id="nameSel"></select>
   <button onclick="addName()">＋</button>
   <button onclick="deleteName()">－</button>
  </div>

  出勤 <input type="time" id="start"><br>
  退勤 <input type="time" id="end"><br><br>

  <button onclick="saveShift()">保存</button>
  <button onclick="closeModal()">キャンセル</button>
 </div>
</div>

<div id="monthly"></div>

<script>
/* ===== localStorage ===== */
const L=k=>JSON.parse(localStorage.getItem(k)||'[]');
const S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

let shifts=L('shifts');
let names=L('names');
if(!names.includes('社員'))names.unshift('社員');
S('names',names);

let editIndex=null, selectedDate=null;

/* ===== 年月 ===== */
const yearSel=document.getElementById('year');
const monthSel=document.getElementById('month');
const now=new Date();

for(let y=2024;y<=2028;y++)
 yearSel.innerHTML+=`<option ${y===now.getFullYear()?'selected':''}>${y}</option>`;
for(let m=1;m<=12;m++)
 monthSel.innerHTML+=`<option ${m===now.getMonth()+1?'selected':''}>${m}</option>`;
yearSel.onchange=monthSel.onchange=renderCalendar;

/* ===== 名前 ===== */
const nameSel=document.getElementById('nameSel');
function renderNames(){
 nameSel.innerHTML='<option value="">選択してください</option>';
 names.forEach(n=>nameSel.innerHTML+=`<option>${n}</option>`);
}
renderNames();

function addName(){
 const n=prompt('名前');
 if(!n||names.includes(n))return;
 names.push(n);S('names',names);renderNames();
}
function deleteName(){
 const n=nameSel.value;
 if(!n||n==='社員')return alert('社員は削除不可');
 names=names.filter(x=>x!==n);S('names',names);renderNames();
}

/* ===== カレンダー ===== */
const calendar=document.getElementById('calendar');

function renderCalendar(){
 calendar.innerHTML='';
 const y=yearSel.value,m=monthSel.value;

 ['日','月','火','水','木','金','土']
 .forEach(w=>calendar.innerHTML+=`<div class="header">${w}</div>`);

 const first=new Date(y,m-1,1).getDay();
 for(let i=0;i<first;i++)calendar.innerHTML+='<div></div>';

 const days=new Date(y,m,0).getDate();
 for(let d=1;d<=days;d++){
  const date=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const box=document.createElement('div');
  box.className='day';
  box.onclick=()=>openModal(date);

  box.innerHTML=`<div class="date">${d}</div>`;

  shifts.filter(s=>s.date===date).forEach((s,i)=>{
   box.innerHTML+=`
    <div class="shift">
     ${s.name}：${s.start}~${s.end}
     <div class="actions">
      <button onclick="event.stopPropagation();editShift('${date}',${i})">編集</button>
      <button onclick="event.stopPropagation();removeShift('${date}',${i})">削除</button>
     </div>
    </div>`;
  });

  calcDaily(date).forEach(r=>{
   box.innerHTML+=`<div class="money">${r.name}：${r.money}円</div>`;
  });

  calendar.appendChild(box);
 }
 renderMonthly();
}

/* ===== モーダル ===== */
const modal=document.getElementById('modal');
const modalDate=document.getElementById('modalDate');
const start=document.getElementById('start');
const end=document.getElementById('end');

function openModal(d){
 selectedDate=d;editIndex=null;
 modalDate.textContent=d;
 modal.style.display='block';
 nameSel.value='';start.value=end.value='';
}
function closeModal(){modal.style.display='none'}

function saveShift(){
 if(!nameSel.value||!start.value||!end.value)return;
 const obj={date:selectedDate,name:nameSel.value,start:start.value,end:end.value};
 editIndex!==null?shifts[editIndex]=obj:shifts.push(obj);
 S('shifts',shifts);closeModal();renderCalendar();
}
function editShift(date,i){
 const list=shifts.filter(s=>s.date===date);
 const s=list[i];
 editIndex=shifts.indexOf(s);
 selectedDate=date;
 modalDate.textContent=date;
 modal.style.display='block';
 nameSel.value=s.name;start.value=s.start;end.value=s.end;
}
function removeShift(date,i){
 const list=shifts.filter(s=>s.date===date);
 shifts=shifts.filter(s=>s!==list[i]);
 S('shifts',shifts);renderCalendar();
}

/* ===== 計算（シフト単位） ===== */
function calcDaily(date){
 const toM=t=>+t.split(':')[0]*60+ +t.split(':')[1];
 const dayShifts=shifts.filter(s=>s.date===date);
 const valid=dayShifts.some(s=>!(toM(s.start)>615&&toM(s.end)<1320));
 if(!valid)return [];

 const minutes=[...Array(1440)].map(()=>[]);
 dayShifts.forEach((s,i)=>{
  let st=toM(s.start),ed=Math.min(toM(s.end),1320);
  for(let t=Math.max(st,0);t<ed;t++)minutes[t].push(i);
 });

 const results=[];

 dayShifts.forEach((s,i)=>{
  let solo=0, overlap=0;

  minutes.forEach(arr=>{
   if(!arr.includes(i))return;
   if(arr.some(j=>dayShifts[j].name==='社員'))return;

   if(arr.length===1) solo+=200/60;
   if(arr.length===2) overlap+=100/60;
  });

  solo=smartRound(solo);
  overlap=smartRound(overlap);

  if(solo>0)results.push({name:s.name,money:solo});
  if(overlap>0)results.push({name:s.name,money:overlap});
 });

 return results;
}


/* ===== 月合計 ===== */
function renderMonthly(){
 const totals={};
 const ym=`${yearSel.value}-${String(monthSel.value).padStart(2,'0')}`;

 // 対象月の日付ごとに処理
 shifts
  .filter(s=>s.date.startsWith(ym))
  .map(s=>s.date)
  .filter((v,i,a)=>a.indexOf(v)===i)
  .forEach(d=>{
   calcDaily(d).forEach(r=>{
    totals[r.name]=(totals[r.name]||0)+r.money;
   });
  });

 // 表示
 monthly.innerHTML='';
 Object.entries(totals).forEach(([name,money])=>{
  if(money>0){
   monthly.innerHTML+=`${name}：${money}円<br>`;
  }
 });
}


function smartRound(x){
 const f=x-Math.floor(x);
 return f>0.999?Math.round(x):Math.floor(x);
}

renderCalendar();
</script>
</body>
</html>