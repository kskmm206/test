<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>自責計算</title>
<style>
body { font-family: sans-serif; }
h1 { text-align:center; }
header { display:flex; justify-content:center; gap:10px; font-size:22px; margin-bottom:10px; }
select { font-size:20px; }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.week { font-weight:bold; text-align:center; }
.day { border:1px solid #ccc; min-height:120px; padding:4px; cursor:pointer; }
.day-number { font-weight:bold; }
.shift { font-size:12px; margin-top:2px; white-space:pre-line; }
.money { font-weight:bold; }
#total { margin-top:15px; font-size:18px; white-space:pre-line; }
#modal { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; justify-content:center; align-items:center; }
#modalContent { background:#fff; padding:15px; width:320px; }
input, select { width:100%; margin-bottom:5px; }
.actions { display:flex; gap:5px; }
</style>
</head>
<body>
<h1>自責計算</h1>
<header>
  <select id="year"></select><span>年</span>
  <select id="month"></select><span>月</span>
</header>
<div id="calendar"></div>
<div id="total"></div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalDate"></h3>
    <select id="nameSelect"></select>
    <input id="newName" placeholder="新しい名前">
    <input type="time" id="start">
    <input type="time" id="end">
    <input type="time" id="breakStart" placeholder="休憩開始">
    <input type="time" id="breakEnd" placeholder="休憩終了">
    <div class="actions">
      <button onclick="saveShift()">保存</button>
      <button onclick="closeModal()">閉じる</button>
    </div>
  </div>
</div>

<script>
const shifts = JSON.parse(localStorage.getItem('shifts')||'{}');
let names = JSON.parse(localStorage.getItem('names')||'["社員"]');
let editIndex = null;
let currentDate = '';

const yearSel = document.getElementById('year');
const monthSel = document.getElementById('month');

for(let y=2024;y<=2030;y++) yearSel.add(new Option(y,y));
for(let m=1;m<=12;m++) monthSel.add(new Option(m,m));

const now=new Date();
yearSel.value=now.getFullYear();
monthSel.value=now.getMonth()+1;

yearSel.onchange=monthSel.onchange=render;

function render(){
 const y=+yearSel.value, m=+monthSel.value;
 const cal=document.getElementById('calendar');
 cal.innerHTML='';
 ['日','月','火','水','木','金','土'].forEach(w=>{
  const d=document.createElement('div'); d.className='week'; d.textContent=w; cal.appendChild(d);
 });
 const first=new Date(y,m-1,1).getDay();
 const last=new Date(y,m,0).getDate();
 for(let i=0;i<first;i++) cal.appendChild(document.createElement('div'));
 for(let d=1;d<=last;d++){
  const key=`${y}-${m}-${d}`;
  const div=document.createElement('div'); div.className='day';
  let html=`<div class='day-number'>${d}</div>`;
  (shifts[key]||[]).forEach((s,i)=>{
    html+=`<div class='shift'>${s.name}：${s.start}~${s.end}${s.break?`（休憩${s.break}）`:''}`;
    if(s.money>0 && s.name!=='社員') html+=`\n<span class='money'>${s.money}円</span>`;
    html+=`<br><button onclick=\"editShift('${key}',${i})\">編集</button>`;
    html+=`<button onclick=\"deleteShift('${key}',${i})\">削除</button></div>`;
  });
  div.innerHTML=html;
  div.onclick=(e)=>{ if(e.target.tagName==='BUTTON')return; openModal(key); };
  cal.appendChild(div);
 }
 calcMonthTotal();
}

function openModal(date){
 currentDate=date; editIndex=null;
 document.getElementById('modal').style.display='flex';
 document.getElementById('modalDate').textContent=date;
 updateNameSelect(); clearInputs();
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function updateNameSelect(){
 const sel=document.getElementById('nameSelect'); sel.innerHTML='';
 sel.add(new Option('選択してください',''));
 names.forEach(n=>sel.add(new Option(n,n)));
}
function clearInputs(){ ['newName','start','end','breakStart','breakEnd'].forEach(id=>document.getElementById(id).value=''); }

function saveShift(){
 const name=document.getElementById('newName').value||nameSelect.value;
 if(!name||!start.value||!end.value) return;
 if(!names.includes(name)) names.push(name);
 localStorage.setItem('names',JSON.stringify(names));
 const money=calcMoney(currentDate,name,start.value,end.value,breakStart.value,breakEnd.value);
 if(!shifts[currentDate]) shifts[currentDate]=[];
 const obj={name,start:start.value,end:end.value,break:breakStart.value&&breakEnd.value?`${breakStart.value}~${breakEnd.value}`:'',money};
 if(editIndex!==null) shifts[currentDate][editIndex]=obj;
 else shifts[currentDate].push(obj);
 localStorage.setItem('shifts',JSON.stringify(shifts));
 closeModal(); render();
}

function editShift(date,i){ const s=shifts[date][i]; openModal(date); editIndex=i;
 nameSelect.value=s.name; start.value=s.start; end.value=s.end;
 if(s.break){ [breakStart.value,breakEnd.value]=s.break.split('~'); }
}
function deleteShift(date,i){ if(!confirm('削除しますか？'))return;
 shifts[date].splice(i,1); localStorage.setItem('shifts',JSON.stringify(shifts)); render(); }

function timeToMin(t){ const[a,b]=t.split(':').map(Number); return a*60+b; }

function calcMoney(date,name,st,en,bs,be){
 if(name==='社員') return 0;
 const dayShifts=(shifts[date]||[]).filter(s=>s.name!=='社員');
 let start=timeToMin(st), end=Math.min(timeToMin(en),1320);
 if(end<=start) return 0;
 if(start>615 && end<1320) return 0;
 let total=0;
 for(let t=start;t<end;t++){
  if(bs&&be && t>=timeToMin(bs)&&t<timeToMin(be)) continue;
  const concurrent=dayShifts.filter(s=>{
    const ss=timeToMin(s.start), ee=timeToMin(s.end);
    return t>=ss && t<ee;
  }).length+1;
  total+= concurrent>=2 ? 100/60 : 200/60;
 }
 return Math.floor(total);
}

function calcMonthTotal(){
 const y=yearSel.value, m=monthSel.value;
 const totals={};
 for(const d in shifts){ if(!d.startsWith(`${y}-${m}-`))continue;
  shifts[d].forEach(s=>{ if(s.name!=='社員') totals[s.name]=(totals[s.name]||0)+s.money; }); }
 document.getElementById('total').textContent='月合計\n'+Object.entries(totals).map(([n,v])=>`${n}：${v}円`).join('\n');
}

render();
</script>
</body>
</html>